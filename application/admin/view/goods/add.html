{include file="public/header" /}
<link type="text/css" rel="stylesheet" href="__UM__/themes/default/css/umeditor.css"/>
<link type="text/css" rel="stylesheet" href="__WEBUPLOADER__/css/webuploader.css"/>
<link type="text/css" rel="stylesheet" href="__WEBUPLOADER__/css/style.css"/>
<style>
	.layui-table th, .layui-table th {
		text-align: center
	}
</style>
<div class="layui-card">
	<div class="layui-card-header">新增商品</div>
	<div class="layui-card-body" style="padding:20px 10px">
		<form class="layui-form" lay-filter="addForm" id="addForm">
			<div class="layui-form-item">
				<div class="layui-inline">
					<label class="layui-form-label">商品编号：</label>
					<div class="layui-input-inline">
						<input type="text" name="sn" value="{$goods.sn|default=$sn}" lay-verify="required" layui-disabled placeholder="请输入商品名称，最多200个字符" autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label"><i class="must">*</i>单位：</label>
					<div class="layui-input-inline">
						<input type="text" name="unit" value="{$goods.uinit|default=''}" lay-verify="required" placeholder="请输入商品单位，比方：件" autocomplete="off" class="layui-input">
					</div>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label"><i class="must">*</i>商品名称：</label>
				<div class="layui-input-block">
					<input type="text" name="title" value="{$goods.title|default=''}" lay-verify="required" placeholder="请输入商品名称，最多200个字符" autocomplete="off" class="layui-input">
				</div>
			</div>

			<div class="hr-line-dashed"></div>
			<div class="layui-form-item">
				<label class="layui-form-label"><i class="must">*</i>商品分类：</label>
				<div class="layui-input-block">
					{volist name="cate" id="v"}
					<div class="layui-col-xs3 layui-col-md2">
						<input type="radio" name="sex" value="nan" title="{$v.name}" {in name="v.id" value="$goods.group|default=1" }checked{/in}>
					</div>
					{/volist}
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label"><i class="must">*</i>商品规格：</label>
				<div class="layui-input-block" id="specView"></div>
			</div>
			<div class="hr-line-dashed20"></div>

			<div class="layui-form-item">
				<label class="layui-form-label"><i class="must">*</i>相册：</label>
				<div class="layui-input-block" id="goods_imgs">
					<div id="container">
						<div id="uploader">
							<div class="queueList">
								<div id="dndArea" class="placeholder">
									<div id="filePicker"></div>
									<p>单次最多可选10张，单张限制10兆</p>
								</div>
							</div>
							<div class="statusBar" style="display:none;">
								<div class="progress">
									<span class="text">0%</span>
									<span class="percentage"></span>
								</div>
								<div class="info"></div>
								<div class="btns">
									<div id="filePicker2"></div>
									<div class="uploadBtn">开始上传</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label"><i class="must">*</i>详细介绍：</label>
				<div class="layui-input-block">
					<!-- 加载编辑器的容器 -->
					<script id="description" name="description" type="text/plain"></script>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">状态：</label>
				<div class="layui-input-inline">
					<input type="checkbox" name="status" value="1"
					       {eq name="user.status|default='1'" value="1" }checked{/eq}
					lay-skin="switch" lay-text="开启|禁用" >
				</div>
				<div class="layui-form-mid layui-word-aux">默认开启</div>
			</div>
			<div class="hr-line-dashed2"></div>
			<div class="layui-form-item">
				<div class="layui-input-block">
					<input type="hidden" name="id" value="{$user.id|default=''}"/>
					<button class="layui-btn" lay-submit lay-filter="addForm">立即提交</button>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
</div>
<script type="text/javascript" src="__JS__/descartes.js"></script>
<script type="text/javascript" src="__UM__/umeditor.config.js"></script>
<script type="text/javascript" src="__UM__/umeditor.min.js"></script>
<script type="text/javascript" src="__WEBUPLOADER__/js/webuploader.js"></script>
<script type="text/javascript" src="__WEBUPLOADER__/js/upload.js"></script>
<script type="text/javascript">
	var arr = ['zhangsan', 'lisi', 'wangwu'];
	// 实例化编辑器
	var ue = UM.getEditor('description', {
		initialFrameWidth: '100%', //初始化编辑器宽度
		initialFrameHeight: 300  //初始化编辑器高度
	});

	// laytpl数据渲染时调用的函数
	function getPureName(fullname) {
		return fullname.split(':')[1];
	}

	layui.use(['form', 'layer', 'jquery', 'laytpl'], function () {
		var form = layui.form, layer = layui.layer,
			$ = layui.jquery, laytpl = layui.laytpl;

		// 如果不想自定义规格的话，回复到原先的设置
		function restore() {
			var tpl = document.getElementById('noSpecHtml').innerHTML; //读取模版
			render = laytpl(tpl).render([]);
			document.getElementById('specView').innerHTML = render;
		}

		makeSpecHtml("1:颜色=2:金色,3:银色;2:内存=7:4G,8:6G");

		// 生成商品规格html,这里以收到的规格字符串 1:颜色=2:金色,3:银色;2:内存=7:4G,8:6G为例子
		function makeSpecHtml(specStringResult) {
			var data = {},
				name_temp_array = [], value_temp_array = [],
				name_id_string = '', name_array = [], value_array = [];

			// specArray切割后为数组  ["1:颜色=2:金色,3:银色", "2:内存=7:4G,8:6G"]
			var specArray = specStringResult.split(';');

			specArray.forEach(function (item) {
				// specItem 就是specArray中的每一项用等号切割开，也是数组
				// 第一次循环specItem为 ["1:颜色", "2:金色,3:银色"]，但是长度总是为2
				var specItem = item.split('=');

				// 第一次specItem[0]为：1:颜色
				name_temp_array = specItem[0].split(':');
				name_id_string += name_temp_array[0] + ',';
				name_array.push(name_temp_array[1]);

				// 第一次value_temp_array为：["2:金色", "3:银色"]
				value_temp_array = specItem[1].split(',');
				value_array.push(value_temp_array);
			});
			value_array = DescartesUtils.descartes(value_array);
			data.name_id_string = name_id_string.slice(0, -1);
			data.names = name_array;
			data.values = value_array;
			data.sn =
			var getTpl = document.getElementById('defineSpecHtml').innerHTML, view = document.getElementById('specView');
			laytpl(getTpl).render(data, function (html) {
				view.innerHTML = html;
			});
		}

		window.makeSpecHtml = makeSpecHtml; // 这句非常关键，iframe子页面调用的时候就靠这句

		//监听新增角色提交
		form.on('submit(addForm)', function (data) {
			var url = "{:url('goods/add')}?t=", okMsg = '系统用户创建成功'; // 添加
			if (data.field.id) {
				// 修改
				url = "{:url('admin/edit')}?t=";
				okMsg = '系统用户修改成功';
			}
			$.post(url + new Date().getTime(), data.field, function (result) {
				if (result.code == 1) {
					window.parent.location.reload(); //刷新父页面
					parent.layer.msg(okMsg, {icon: 1, time: 2000});
				} else {
					layer.msg(result.msg, {icon: 2});
				}
			}, 'json');
			return false;
		});
		// 添加商品规格监听
		$('#addForm').on('click', '.addSpec', function () {
			// 获取已经存在的规格
			var spec_init_str = '';
			$("input[name='spec_item[]']").each(function () {
				spec_init_str += $(this).val() + ',';
			});
			layer.open({
				type: 2,
				skin: 'layui-layer-molv',
				area: ['730px', '480px'],
				shadeClose: true,
				title: '商品规格（点选当前商品所需要规格，支持多选）',
				content: "{:url('goods/spec_select')}",
				success: function (layero, index) {
					var childFrame = layer.getChildFrame('body', index);//建立父子联系
					var iframeWin = window[layero.find('iframe')[0]['name']];
					// 向子页面的全局函数child传参
					iframeWin.spec_init(spec_init_str);
				}
			});
		});
		$(function () {
			restore();
			// 关闭规格
			$('#specView').on('click', '.resetSpec', function () {
				var index = layer.confirm('确定要关闭商品所有规格吗？',
					{title: '关闭规格', icon: 0, btn: ['确定', '取消']},
					function () {
						restore();
						layer.close(index);
					});
				return false;
			})
		})
	});
</script>
<script type="text/html" id="defineSpecHtml">
	<a class="layui-btn layui-btn-warm resetSpec" href="javascript:void(0)"><i class="fa fa-times"></i> 关闭规格</a>
	<a class="layui-btn addSpec" href="javascript:void(0)"><i class="fa fa-plus"></i> 编辑规格</a>
	<table class="layui-table" lay-skin="line" lay-size="sm" style="text-align:center">
		<thead>
		<tr>
			<th><i class="must">*</i>货号</th>
			{{# layui.each(d.names, function(i, v){ }}
			<th>
				{{ v }}
			</th>
			{{# }); }}
			<th>
				<input type="hidden" value="d.name_id_string" name="spec_items">
				<i class="must">*</i>库存
			</th>
			<th><i class="must">*</i>预警线</th>
			<th><i class="must">*</i>价格</th>
			<th>操作</th>
		</tr>
		</thead>
		<tbody>
		{{# for(var i = 0, len = d.values.length; i < len; i++){ }}
		<tr>
			<td>
				<input type="text" name="sn[]" lay-verify="required" autocomplete="off" class="layui-input">
			</td>
			{{# layui.each(d.values[i], function(index, item){ }}
			<td>

				{{ getPureName(item) }}
			</td>
			{{# }); }}
			<td>
				<input type="hidden" value="{{ d.values[i] }}" name="spec_item[]">
				<input type="text" name="stock[]" lay-verify="required" autocomplete="off" class="layui-input">
			</td>
			<td>
				<input type="text" name="warning_line[]" value="2" lay-verify="required" autocomplete="off" class="layui-input">
			</td>
			<td>
				<input type="text" name="price[]" lay-verify="required" autocomplete="off" class="layui-input">
			</td>
			<td>
				<a href="javascript:void(0)" class="lay-btn">删除</a>
			</td>
		</tr>
		{{# } }}
		</tbody>
	</table>
</script>
<script type="text/html" id="noSpecHtml">
	<a class="layui-btn addSpec" href="javascript:void(0)"><i class="fa fa-plus"></i> 开启规格</a>
	<table class="layui-table" lay-size="sm">
		<thead>
		<tr>
			<th><i class="must">*</i>货号</th>
			<th><i class="must">*</i>库存</th>
			<th><i class="must">*</i>预警线</th>
			<th><i class="must">*</i>价格</th>
		</tr>
		</thead>
		<tbody>
		<tr>
			<td>
				<input type="text" name="sn[]" lay-verify="required" autocomplete="off" class="layui-input">
			</td>
			<td>
				<input type="text" name="stock[]" lay-verify="required" autocomplete="off" class="layui-input">
			</td>
			<td>
				<input type="text" name="warning_line[]" value="2" lay-verify="required" autocomplete="off" class="layui-input">
			</td>
			<td>
				<input type="text" name="price[]" lay-verify="required" autocomplete="off" class="layui-input">
			</td>
		</tr>
		</tbody>
	</table>
</script>
{include file="public/footer" /}